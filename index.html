<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analizador y Comparador de Precios</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js - Versión completa. Debe ser lo primero en cargar el JavaScript. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    
    <!-- Importación de la fuente 'Inter' -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Aplicar la fuente corporativa a toda la app */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para el input de archivo personalizado */
        .file-input-label {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        /* Ocultar el input de archivo real */
        #pdf-upload {
            display: none;
        }
        /* Estilo para el spinner de carga */
        .loader {
            border: 4px solid #f3f4f6; /* gray-100 */
            border-top: 4px solid #1f2937; /* gray-800 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Estilos de Pestañas */
        .tab-btn.active {
            border-bottom-color: #1f2937; /* gray-800 */
            color: #1f2937; /* gray-800 */
            font-weight: 600;
        }
        .tab-btn {
            border-bottom-width: 3px;
            border-bottom-color: transparent;
            color: #6b7280; /* gray-500 */
        }

        /* Fija la columna de producto en la tabla de comparación para móvil */
        #tabla-comparacion-precios .sticky-col {
            position: sticky;
            left: 0;
            background-color: white; /* Asegurar que el fondo sea blanco */
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Canvas oculto para renderizar las páginas del PDF -->
    <canvas id="pdf-canvas" class="hidden"></canvas>

    <!-- Contenedor principal -->
    <div class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Encabezado -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900">Analizador y Comparador de Precios</h1>
            <p class="text-lg text-gray-600 mt-1">Extrae tus compras de la factura y compara dónde es mejor mercar en Copacabana.</p>
        </header>

        <!-- Pestañas de Navegación -->
        <div class="mb-6 border-b border-gray-300">
            <nav class="flex -mb-px space-x-6 overflow-x-auto">
                <button id="btn-tab-analisis" class="tab-btn active py-3 px-1 text-base whitespace-nowrap" onclick="mostrarTab('tab-analisis')">
                    1. Analizar Factura (Merkahorro)
                </button>
                <button id="btn-tab-comparacion" class="tab-btn py-3 px-1 text-base whitespace-nowrap" onclick="mostrarTab('tab-comparacion')">
                    2. Comparación de Precios
                </button>
            </nav>
        </div>

        <!-- Contenido de las Pestañas -->
        <div>
            <!-- Pestaña 1: Analizar Factura (Activa por defecto) -->
            <div id="tab-analisis">
                <div class="max-w-4xl mx-auto">
                    <!-- Sección de Carga -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                        <h2 class="text-xl font-semibold mb-4">Paso 1: Adjuntar Factura</h2>
                        <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-4">
                            <!-- Botón para seleccionar archivo -->
                            <label for="pdf-upload" class="file-input-label w-full sm:w-auto text-center bg-white border border-gray-300 text-gray-700 font-medium py-2.5 px-6 rounded-lg shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                                <span id="file-label-text">Seleccionar Factura (PDF)</span>
                            </label>
                            <input type="file" id="pdf-upload" accept="application/pdf">

                            <!-- Botón para procesar -->
                            <button id="process-button" class="mt-3 sm:mt-0 w-full sm:w-auto bg-gray-800 text-white font-medium py-2.5 px-6 rounded-lg shadow-sm hover:bg-gray-700 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2" disabled>
                                Procesar Factura
                            </button>
                        </div>
                        <p id="file-error" class="text-red-600 text-sm mt-3 hidden">Por favor, selecciona un archivo PDF.</p>
                    </div>

                    <!-- Sección de Resultados y Carga -->
                    <div id="results-container">
                        <!-- Estado de Carga -->
                        <div id="loading-state" class="hidden flex-col items-center justify-center bg-white p-12 rounded-2xl shadow-lg text-center">
                            <div class="loader"></div>
                            <p id="loading-text" class="text-lg font-medium text-gray-700 mt-6">Analizando factura... Esto puede tardar un momento.</p>
                            <p class="text-gray-500">Procesando página <span id="current-page">1</span> de <span id="total-pages">1</span></p>
                        </div>

                        <!-- Estado de Error de API -->
                        <div id="api-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg shadow-lg" role="alert">
                            <h3 class="font-bold">Error en el Análisis</h3>
                            <p id="api-error-message">No se pudo procesar la factura. Intenta de nuevo.</p>
                        </div>

                        <!-- Tabla de Resultados -->
                        <div id="results-table" class="hidden bg-white rounded-2xl shadow-lg overflow-hidden">
                            <h2 class="text-xl font-semibold p-6">Productos Extraídos (Merkahorro)</h2>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Descripción del Producto</th>
                                            <th scope="col" class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Precio Unitario</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-resultados" class="bg-white divide-y divide-gray-200">
                                        <!-- Filas de productos se insertarán aquí -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Botón para pasar a la comparación -->
                        <div id="comparison-prompt" class="hidden mt-6 text-center">
                            <button onclick="mostrarTab('tab-comparacion')" class="bg-green-600 text-white font-medium py-3 px-8 rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                ➡️ Ir a Comparación de Precios
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña 2: Comparación de Precios (Oculta por defecto) -->
            <div id="tab-comparacion" class="hidden">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-2">Comparación de Precios en Copacabana y Bello</h2>
                    <p class="text-gray-600 mb-6">Comparación entre los precios de tu factura (Merkahorro) y precios simulados de otros supermercados cercanos. El precio más bajo se resalta en verde.</p>
                    
                    <div id="comparison-error-message" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4" role="alert">
                        <p class="font-bold">¡Atención!</p>
                        <p>Debes analizar la factura de Merkahorro primero en la pestaña "Analizar Factura" para generar los datos de comparación.</p>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider sticky left-0 bg-gray-50 z-10 sticky-col">Producto</th>
                                    <th class="px-3 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Merkahorro (Factura)</th>
                                    <th class="px-3 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Éxito (P. Norte)</th>
                                    <th class="px-3 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">L Pineda (Simulado)</th>
                                    <th class="px-3 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">La 200 (Simulado)</th>
                                    <th class="px-3 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">Mejor Opción</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-comparacion-precios" class="bg-white divide-y divide-gray-200">
                                <!-- Resultados de la comparación se insertan aquí -->
                                <tr id="fila-vacia-comparacion">
                                    <td colspan="6" class="px-6 py-12 text-center text-gray-500">
                                        Analiza tu factura de Merkahorro para ver la comparación aquí.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Módulo de Resumen de Ahorro (NUEVA SECCIÓN) -->
                    <div id="summary-module" class="mt-8 pt-6 border-t border-gray-200 hidden">
                        <h3 class="text-2xl font-bold mb-4">Resumen y Mejor Opción Global 
                            <svg class="inline-block w-6 h-6 ml-2 text-yellow-600" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M10 2a8 8 0 100 16A8 8 0 0010 2zm.003 14a6 6 0 100-12 6 6 0 000 12zM10 8a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1zm0 5a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd"/>
                                <path d="M10 3a7 7 0 100 14 7 7 0 000-14zM10 16a6 6 0 100-12 6 6 0 000 12zM10 8a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1z" fill="#f59e0b"/>
                                <path fill-rule="evenodd" d="M12 5a3 3 0 10-6 0v2a1 1 0 002 0V6a1 1 0 012 0v1a1 1 0 002 0V5zM10 12a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd"/>
                            </svg>
                        </h3>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            
                            <!-- Tarjeta 1: Costo en Merkahorro -->
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg shadow-md">
                                <p class="text-sm font-medium text-blue-700">Costo de tu Factura (Merkahorro)</p>
                                <p id="total-merkahorro" class="text-3xl font-extrabold text-blue-800 mt-1">$0</p>
                            </div>

                            <!-- Tarjeta 2: Costo Mínimo Teórico -->
                            <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg shadow-md">
                                <p class="text-sm font-medium text-green-700">Costo Mínimo Teórico</p>
                                <p id="total-minimo" class="text-3xl font-extrabold text-green-800 mt-1">$0</p>
                                <p class="text-xs text-green-600 mt-1">Si hubieras comprado cada producto al mejor precio.</p>
                            </div>

                            <!-- Tarjeta 3: Ahorro Potencial -->
                            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg shadow-md">
                                <p class="text-sm font-medium text-yellow-700">Ahorro Potencial</p>
                                <p id="total-ahorro" class="text-3xl font-extrabold text-yellow-800 mt-1">$0</p>
                            </div>
                        </div>

                        <!-- Tarjeta 4: Mejor Lugar para Comprar Todo -->
                        <div class="mt-6 bg-gray-50 p-6 rounded-lg border-2 border-gray-300 shadow-xl text-center">
                            <p class="text-lg font-semibold text-gray-700">Si hubieras hecho toda la compra en un solo lugar, el más económico habría sido:</p>
                            <p id="mejor-lugar-global" class="text-4xl font-black text-gray-900 mt-3"></p>
                            <p id="costo-mejor-lugar" class="text-xl font-medium text-gray-600 mt-1"></p>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN E INICIALIZACIÓN ---

        // Clave de API (se deja vacía, será gestionada por el entorno)
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        // Almacenamiento global para los resultados del análisis
        let productosMerkahorro = [];
        let productosParaComparar = []; // Productos con precios simulados de otros supers
        
        // Nombres de los supermercados para la comparación
        const SUPERMERCADOS = {
            merkahorro: 'Merkahorro',
            exito: 'Éxito (P. Norte)',
            lPineda: 'L Pineda (Simulado)',
            la200: 'La 200 (Simulado)'
        };

        // Referencias al DOM
        const pdfUpload = document.getElementById('pdf-upload');
        const processButton = document.getElementById('process-button');
        const fileLabelText = document.getElementById('file-label-text');
        const fileError = document.getElementById('file-error');
        
        const loadingState = document.getElementById('loading-state');
        const loadingText = document.getElementById('loading-text');
        const currentPageEl = document.getElementById('current-page');
        const totalPagesEl = document.getElementById('total-pages');
        
        const apiError = document.getElementById('api-error');
        const apiErrorMessage = document.getElementById('api-error-message');

        const resultsTable = document.getElementById('results-table');
        const tablaResultados = document.getElementById('tabla-resultados');
        const comparisonPrompt = document.getElementById('comparison-prompt');

        const tablaComparacion = document.getElementById('tabla-comparacion-precios');
        const filaVaciaComparacion = document.getElementById('fila-vacia-comparacion');
        const comparisonErrorMessage = document.getElementById('comparison-error-message');
        
        // DOM del resumen
        const summaryModule = document.getElementById('summary-module');
        const totalMerkahorroEl = document.getElementById('total-merkahorro');
        const totalMinimoEl = document.getElementById('total-minimo');
        const totalAhorroEl = document.getElementById('total-ahorro');
        const mejorLugarGlobalEl = document.getElementById('mejor-lugar-global');
        const costoMejorLugarEl = document.getElementById('costo-mejor-lugar');

        let selectedFile = null;

        /**
         * Maneja la visualización de pestañas.
         */
        function mostrarTab(tabId) {
            // Ocultar todos los contenidos
            document.getElementById('tab-analisis').classList.add('hidden');
            document.getElementById('tab-comparacion').classList.add('hidden');

            // Quitar clase 'active' de todos los botones
            document.getElementById('btn-tab-analisis').classList.remove('active');
            document.getElementById('btn-tab-comparacion').classList.remove('active');

            // Mostrar el contenido seleccionado
            document.getElementById(tabId).classList.remove('hidden');
            // Marcar el botón como 'active'
            document.getElementById(`btn-${tabId}`).classList.add('active');

            // Lógica específica al mostrar la pestaña de comparación
            if (tabId === 'tab-comparacion') {
                if (productosMerkahorro.length > 0) {
                    comparisonErrorMessage.classList.add('hidden');
                    renderizarComparacion();
                    calcularYMostrarResumen();
                } else {
                    comparisonErrorMessage.classList.remove('hidden');
                    tablaComparacion.innerHTML = `<tr id="fila-vacia-comparacion"><td colspan="6" class="px-6 py-12 text-center text-gray-500">Analiza tu factura de Merkahorro para ver la comparación aquí.</td></tr>`;
                    summaryModule.classList.add('hidden');
                }
            }
        }


        // --- MANEJADORES DE EVENTOS Y LÓGICA DE INICIO ---

        // **CORRECCIÓN CLAVE:** Envolver los manejadores de eventos en DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Establecer la pestaña inicial
            mostrarTab('tab-analisis');

            // 2. Manejadores de Eventos
            pdfUpload.addEventListener('change', (e) => {
                selectedFile = e.target.files[0];
                if (selectedFile && selectedFile.type === 'application/pdf') {
                    fileLabelText.textContent = selectedFile.name;
                    processButton.disabled = false;
                    fileError.classList.add('hidden');
                } else {
                    fileLabelText.textContent = 'Seleccionar Factura (PDF)';
                    processButton.disabled = true;
                    fileError.classList.remove('hidden');
                    selectedFile = null;
                }
            });

            processButton.addEventListener('click', () => {
                if (selectedFile) {
                    // Reiniciar la UI a un estado de carga
                    resetUI();
                    loadingState.classList.remove('hidden');
                    processPDF(selectedFile);
                }
            });
        });

        // --- LÓGICA DE PROCESAMIENTO DE PDF ---
        
        /**
         * Procesa el archivo PDF página por página.
         */
        async function processPDF(file) {
            // Verificar si pdfjsLib existe (doble check de seguridad)
            if (typeof pdfjsLib === 'undefined' || !pdfjsLib.getDocument) {
                // Esta verificación es la clave para evitar el ReferenceError
                showError("La librería PDF.js no se cargó o inicializó correctamente. Por favor, intenta recargar la página.");
                return;
            }

            try {
                const fileReader = new FileReader();
                fileReader.onload = async (e) => {
                    const typedarray = new Uint8Array(e.target.result);
                    
                    // Inicializar el documento PDF
                    const pdf = await pdfjsLib.getDocument({data: typedarray}).promise; 

                    totalPagesEl.textContent = pdf.numPages;
                    productosMerkahorro = []; // Limpiar resultados anteriores

                    // Procesar cada página en secuencia
                    for (let i = 1; i <= pdf.numPages; i++) {
                        currentPageEl.textContent = i;
                        loadingText.textContent = `Analizando página ${i} de ${pdf.numPages}...`;
                        
                        const base64Image = await renderPageAsImage(pdf, i);
                        const items = await analyzeImageWithGemini(base64Image);
                        if (items) {
                            // Concatenar y limpiar productos duplicados o inválidos
                            const newItems = items.filter(
                                item => item.descripcion && typeof item.precioUnitario === 'number' && item.precioUnitario > 0
                            );
                            productosMerkahorro = productosMerkahorro.concat(newItems);
                        }
                    }

                    // Filtrar duplicados por descripción (puede haber productos repetidos en la factura)
                    const uniqueProducts = {};
                    productosMerkahorro.forEach(item => {
                        // Usar una clave normalizada para evitar duplicados por espacios/mayúsculas
                        const key = item.descripcion.trim().toUpperCase();
                        if (!uniqueProducts[key] || item.precioUnitario > uniqueProducts[key].precioUnitario) {
                            uniqueProducts[key] = item; // Mantener el precio unitario más alto si hay duplicados (más seguro)
                        }
                    });
                    productosMerkahorro = Object.values(uniqueProducts);


                    // Proceso completado
                    loadingState.classList.add('hidden');
                    if (productosMerkahorro.length > 0) {
                        renderizarResultadosFactura(productosMerkahorro);
                        comparisonPrompt.classList.remove('hidden');
                        generarDatosComparacion(productosMerkahorro);
                    } else {
                        showError("No se encontraron productos válidos en la factura o no se pudo analizar. Intenta con una factura de mejor calidad.");
                    }
                };
                fileReader.readAsArrayBuffer(file);
            } catch (error) {
                console.error("Error al procesar PDF:", error);
                showError("Error al leer el archivo PDF. Asegúrate de que no esté dañado o inténtalo de nuevo.");
            }
        }

        /**
         * Renderiza una página específica del PDF a un canvas y la exporta como Base64.
         */
        async function renderPageAsImage(pdf, pageNum) {
            const page = await pdf.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 }); // Escala para mejor resolución
            
            const canvas = document.getElementById('pdf-canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };

            await page.render(renderContext).promise;
            
            // Exportar como JPEG (suele ser más pequeño para la API) y quitar prefijo
            return canvas.toDataURL('image/jpeg', 0.8).split(',')[1]; // 0.8 de calidad
        }

        // --- LÓGICA DE API (GEMINI) ---

        /**
         * Envía la imagen de la página de la factura a la API de Gemini para su análisis.
         */
        async function analyzeImageWithGemini(base64ImageData) {
            const prompt = "Extrae todos los productos, sus descripciones y su 'Precio unitario' (el precio antes de descuentos o impuestos si es posible) de esta página de factura. Ignora totales, subtotales, impuestos y cualquier otro texto que no sea un producto. Devuelve solo un array de objetos JSON.";

            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: "image/jpeg",
                                    data: base64ImageData
                                }
                            }
                        ]
                    }
                ],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "descripcion": { "type": "STRING" },
                                "precioUnitario": { "type": "NUMBER" }
                            },
                            required: ["descripcion", "precioUnitario"]
                        }
                    }
                }
            };

            try {
                // Usar reintento exponencial para la llamada a la API
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Error de API: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonText);
                    return Array.isArray(parsedJson) ? parsedJson : [];
                } else {
                    console.warn("La API no devolvió candidatos:", result);
                    return [];
                }

            } catch (error) {
                console.error("Error en analyzeImageWithGemini:", error);
                // No mostrar error crítico aquí, solo en el proceso principal, ya que es un reintento por página
                return null;
            }
        }

        /**
         * Función fetch con reintentos exponenciales.
         */
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            try {
                return await fetch(url, options);
            } catch (err) {
                if (retries > 0) {
                    // console.log(`Reintento de fetch (${retries} restantes)...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                } else {
                    throw err;
                }
            }
        }

        // --- LÓGICA DE COMPARACIÓN Y SIMULACIÓN ---
        
        /**
         * Genera precios simulados para la comparación.
         * @param {Array} items - Productos extraídos de Merkahorro.
         */
        function generarDatosComparacion(items) {
            productosParaComparar = items.map(item => {
                const basePrice = item.precioUnitario;

                // Simulación: Merkahorro como referencia
                const merkahorro = basePrice;
                
                // Simulación: Éxito (Puerta del Norte) - Generalmente un poco más alto
                let exito = Math.round(basePrice * (1 + (Math.random() * 0.08 + 0.02))); // +2% a +10%
                exito = Math.ceil(exito / 100) * 100; // Redondear a la centena superior
                if (exito < basePrice) exito = basePrice + 100;

                // Simulación: Supermercado L Pineda - Puede ser muy competitivo (Copacabana)
                let lPineda = Math.round(basePrice * (1 + (Math.random() * 0.04 - 0.02))); // -2% a +2%
                lPineda = Math.ceil(lPineda / 100) * 100; // Redondear a la centena superior

                // Simulación: Supermercado La 200 - Rango similar a Merkahorro
                let la200 = Math.round(basePrice * (1 + (Math.random() * 0.05 + 0.01))); // +1% a +6%
                la200 = Math.ceil(la200 / 100) * 100; // Redondear a la centena superior
                if (la200 < basePrice) la200 = basePrice + 100;


                return {
                    descripcion: item.descripcion,
                    precios: {
                        merkahorro: merkahorro,
                        exito: exito,
                        lPineda: lPineda,
                        la200: la200
                    }
                };
            });
        }

        /**
         * Calcula el resumen total de la compra y el mejor lugar global.
         */
        function calcularYMostrarResumen() {
            if (productosParaComparar.length === 0) {
                summaryModule.classList.add('hidden');
                return;
            }

            // 1. Calcular totales por supermercado y total mínimo
            let totalMerkahorro = 0;
            let totalMinimo = 0;
            
            // Totales por lugar (para encontrar el mejor lugar global)
            let totalesPorSuper = {
                merkahorro: 0,
                exito: 0,
                lPineda: 0,
                la200: 0
            };

            productosParaComparar.forEach(item => {
                const p = item.precios;

                // Suma para el total de la factura original
                totalMerkahorro += p.merkahorro;
                
                // Suma para el total por supermercado simulado
                totalesPorSuper.merkahorro += p.merkahorro;
                totalesPorSuper.exito += p.exito;
                totalesPorSuper.lPineda += p.lPineda;
                totalesPorSuper.la200 += p.la200;


                // Encontrar el precio más bajo para este producto (el 'teórico')
                const min = Math.min(p.merkahorro, p.exito, p.lPineda, p.la200);
                totalMinimo += min;
            });

            // 2. Encontrar el mejor lugar global (el más barato si todo se comprara allí)
            const totales = {
                [SUPERMERCADOS.merkahorro]: totalesPorSuper.merkahorro,
                [SUPERMERCADOS.exito]: totalesPorSuper.exito,
                [SUPERMERCADOS.lPineda]: totalesPorSuper.lPineda,
                [SUPERMERCADOS.la200]: totalesPorSuper.la200
            };

            let mejorLugar = { name: '', total: Infinity };

            for (const [name, total] of Object.entries(totales)) {
                if (total < mejorLugar.total) {
                    mejorLugar.name = name;
                    mejorLugar.total = total;
                }
            }

            // 3. Calcular el ahorro potencial
            const ahorroPotencial = totalMerkahorro - totalMinimo;

            // 4. Renderizar el resumen
            totalMerkahorroEl.textContent = formatearMoneda(totalMerkahorro);
            totalMinimoEl.textContent = formatearMoneda(totalMinimo);
            // Mostrar el ahorro potencial solo si es positivo
            if (ahorroPotencial > 0) {
                totalAhorroEl.textContent = formatearMoneda(ahorroPotencial);
                totalAhorroEl.parentElement.classList.remove('bg-red-50', 'border-red-500');
                totalAhorroEl.parentElement.classList.add('bg-yellow-50', 'border-yellow-500');
            } else {
                totalAhorroEl.textContent = formatearMoneda(0);
                totalAhorroEl.parentElement.classList.remove('bg-yellow-50', 'border-yellow-500');
                totalAhorroEl.parentElement.classList.add('bg-red-50', 'border-red-500');
            }

            
            mejorLugarGlobalEl.textContent = mejorLugar.name;
            costoMejorLugarEl.textContent = `Costo total: ${formatearMoneda(mejorLugar.total)}`;
            
            // Mostrar el módulo de resumen
            summaryModule.classList.remove('hidden');
        }

        // --- RENDERIZADO Y UI ---

        /**
         * Resetea la UI al estado inicial antes de un nuevo procesamiento.
         */
        function resetUI() {
            loadingState.classList.add('hidden');
            apiError.classList.add('hidden');
            resultsTable.classList.add('hidden');
            comparisonPrompt.classList.add('hidden');
            tablaResultados.innerHTML = '';
            // Asegúrate de que la fila vacía esté presente al resetear la tabla de comparación
            tablaComparacion.innerHTML = `<tr id="fila-vacia-comparacion"><td colspan="6" class="px-6 py-12 text-center text-gray-500">Analiza tu factura de Merkahorro para ver la comparación aquí.</td></tr>`;
            filaVaciaComparacion.style.display = 'table-row';
            comparisonErrorMessage.classList.add('hidden');
            summaryModule.classList.add('hidden'); // Ocultar resumen al resetear
        }

        /**
         * Muestra un mensaje de error en la UI.
         */
        function showError(message) {
            loadingState.classList.add('hidden');
            apiErrorMessage.textContent = message;
            apiError.classList.remove('hidden');
            processButton.disabled = false; // Permitir reintento
        }

        /**
         * Formatea un número como moneda COP (Peso Colombiano).
         */
        function formatearMoneda(valor) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(valor);
        }

        /**
         * Muestra los resultados de la extracción de la factura.
         */
        function renderizarResultadosFactura(items) {
            tablaResultados.innerHTML = '';
            
            // Llenar tabla de resultados
            items.forEach(item => {
                const fila = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-normal text-sm font-medium text-gray-900">${item.descripcion}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 text-right">${formatearMoneda(item.precioUnitario)}</td>
                    </tr>
                `;
                tablaResultados.innerHTML += fila;
            });

            // Mostrar sección de resultados
            resultsTable.classList.remove('hidden');
        }

        /**
         * Muestra la tabla de comparación de precios.
         */
        function renderizarComparacion() {
            if (productosParaComparar.length === 0) {
                // Si la fila vacía existe, asegúrate de que se muestre
                const emptyRow = document.getElementById('fila-vacia-comparacion');
                if (emptyRow) emptyRow.style.display = 'table-row';
                return;
            }

            // Ocultar la fila vacía
            const emptyRow = document.getElementById('fila-vacia-comparacion');
            if (emptyRow) emptyRow.style.display = 'none';

            tablaComparacion.innerHTML = '';
            
            productosParaComparar.forEach(item => {
                const precios = item.precios;
                // Filtrar solo valores numéricos válidos
                const valores = Object.values(precios).filter(v => typeof v === 'number'); 
                const minPrecio = valores.length > 0 ? Math.min(...valores) : 0;

                let mejorSuper = '';
                
                const getCelda = (precio, key) => {
                    const supermercado = SUPERMERCADOS[key];
                    // Es el precio mínimo (y el precio es positivo)
                    const isMin = precio === minPrecio && precio > 0; 
                    
                    if (isMin) mejorSuper = supermercado.replace(' (Simulado)', ''); 
                    
                    const classes = isMin 
                        ? 'bg-green-100 text-green-700 font-bold p-2 inline-block w-24 text-center rounded-md shadow-sm' 
                        : 'text-gray-900 p-2 inline-block w-24 text-center';

                    return `<td class="px-3 py-4 whitespace-nowrap text-sm text-center">
                                <span class="${classes}">${formatearMoneda(precio)}</span>
                            </td>`;
                };

                const fila = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-4 text-sm font-medium text-gray-900 sticky-col">${item.descripcion}</td>
                        ${getCelda(precios.merkahorro, 'merkahorro')}
                        ${getCelda(precios.exito, 'exito')}
                        ${getCelda(precios.lPineda, 'lPineda')}
                        ${getCelda(precios.la200, 'la200')}
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-center font-semibold text-gray-700">
                            ${mejorSuper || 'N/A'}
                        </td>
                    </tr>
                `;
                tablaComparacion.innerHTML += fila;
            });
        }
    </script>
</body>
</html>
